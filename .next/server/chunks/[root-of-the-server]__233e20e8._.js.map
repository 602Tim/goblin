{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///D:/113-2/Breakfast-final-project/app/api/order/%5BorderId%5D/status/route.js"],"sourcesContent":["const { orderId } = params;\r\nconst { status, paymentStatus } = await req.json();\r\n\r\nif (!orderId) {\r\n  return new Response(\"Áº∫Â∞ëË®ÇÂñÆ ID\", { status: 400 });\r\n}\r\n\r\ntry {\r\n  const order = await prisma.order.findUnique({\r\n    where: { id: orderId },\r\n  });\r\n\r\n  if (!order) {\r\n    return new Response(\"Êâæ‰∏çÂà∞Ë®ÇÂñÆ\", { status: 404 });\r\n  }\r\n\r\n  const data = {};\r\n\r\n  // ‚úÖ Â¶ÇÊûúÊ≤íÂ∏∂ statusÔºå‰ΩÜÂªöÂ∏´ÂèØËÉΩÂè™ÊòØÊÉ≥Ê®ôË®ò completedAt\r\n  if (!status && order.status === \"PREPARING\" && order.completedAt === null) {\r\n    data.completedAt = new Date();\r\n  }\r\n\r\n  if (status) data.status = status;\r\n  if (paymentStatus !== undefined) data.paymentStatus = paymentStatus;\r\n  if (status === \"COMPLETED\") data.completedAt = new Date();\r\n\r\n  // ‚úÖ Ëã•Ë¶ÅËΩâÊàê READYÔºåÂÖàÊ™¢Êü•ÊòØÂê¶‰ªòÊ¨æ„ÄÅË£Ω‰ΩúÂÆåÊàê\r\n  if (status === \"READY\") {\r\n    if (order.status !== \"PREPARING\") {\r\n      return new Response(\"ÁãÄÊÖãÂøÖÈ†àÁÇ∫ PREPARING ÊâçËÉΩËΩâÁÇ∫ READY\", { status: 400 });\r\n    }\r\n\r\n    if (!order.paymentStatus && paymentStatus !== true) {\r\n      return new Response(\"Â∞öÊú™Á¢∫Ë™ç‰ªòÊ¨æÔºå‰∏çËÉΩËΩâÁÇ∫ READY\", { status: 400 });\r\n    }\r\n\r\n    const isMarkedDone = order.completedAt !== null || data.completedAt !== undefined;\r\n    if (!isMarkedDone) {\r\n      return new Response(\"Â∞öÊú™ÂÆåÊàêË£Ω‰ΩúÔºå‰∏çËÉΩËΩâÁÇ∫ READY\", { status: 400 });\r\n    }\r\n  }\r\n\r\n  const updated = await prisma.order.update({\r\n    where: { id: orderId },\r\n    data,\r\n  });\r\n\r\n  // ‚úÖ ÁôºÈÄÅ MQTT ÈÄöÁü•\r\n  if (status === \"READY\" || status === \"COMPLETED\") {\r\n    const mqtt = await getMqttClient();\r\n    const topic =\r\n      status === \"READY\"\r\n        ? getKitchenReadyOrderTopic(order.customerId)\r\n        : getStaffCompletedOrderTopic(order.customerId);\r\n\r\n    const payload = JSON.stringify({ orderId, status });\r\n\r\n    mqtt.publish(topic, payload, { qos: 1 }, (err) => {\r\n      if (err) {\r\n        console.error(\"‚ùå ÁôºÈÄÅ MQTT ÈÄöÁü•Â§±Êïó:\", err);\r\n      } else {\r\n        console.log(`üì¢ Â∑≤ÁôºÈÄÅ ${status} ÁãÄÊÖãÈÄöÁü•Ëá≥ ${topic}`);\r\n      }\r\n    });\r\n  }\r\n\r\n  return NextResponse.json(updated);\r\n} catch (err) {\r\n  console.error(\"‚ùå Êõ¥Êñ∞Ë®ÇÂñÆÁãÄÊÖãÂ§±Êïó:\", err);\r\n  return new Response(\"‰º∫ÊúçÂô®ÈåØË™§\", { status: 500 });\r\n}\r\n"],"names":[],"mappings":"AAAA,MAAM,EAAE,OAAO,EAAE,GAAG;AACpB,MAAM,EAAE,MAAM,EAAE,aAAa,EAAE,GAAG,MAAM,IAAI,IAAI;AAEhD,IAAI,CAAC,SAAS;IACZ,OAAO,IAAI,SAAS,WAAW;QAAE,QAAQ;IAAI;AAC/C;AAEA,IAAI;IACF,MAAM,QAAQ,MAAM,OAAO,KAAK,CAAC,UAAU,CAAC;QAC1C,OAAO;YAAE,IAAI;QAAQ;IACvB;IAEA,IAAI,CAAC,OAAO;QACV,OAAO,IAAI,SAAS,SAAS;YAAE,QAAQ;QAAI;IAC7C;IAEA,MAAM,OAAO,CAAC;IAEd,uCAAuC;IACvC,IAAI,CAAC,UAAU,MAAM,MAAM,KAAK,eAAe,MAAM,WAAW,KAAK,MAAM;QACzE,KAAK,WAAW,GAAG,IAAI;IACzB;IAEA,IAAI,QAAQ,KAAK,MAAM,GAAG;IAC1B,IAAI,kBAAkB,WAAW,KAAK,aAAa,GAAG;IACtD,IAAI,WAAW,aAAa,KAAK,WAAW,GAAG,IAAI;IAEnD,4BAA4B;IAC5B,IAAI,WAAW,SAAS;QACtB,IAAI,MAAM,MAAM,KAAK,aAAa;YAChC,OAAO,IAAI,SAAS,8BAA8B;gBAAE,QAAQ;YAAI;QAClE;QAEA,IAAI,CAAC,MAAM,aAAa,IAAI,kBAAkB,MAAM;YAClD,OAAO,IAAI,SAAS,qBAAqB;gBAAE,QAAQ;YAAI;QACzD;QAEA,MAAM,eAAe,MAAM,WAAW,KAAK,QAAQ,KAAK,WAAW,KAAK;QACxE,IAAI,CAAC,cAAc;YACjB,OAAO,IAAI,SAAS,qBAAqB;gBAAE,QAAQ;YAAI;QACzD;IACF;IAEA,MAAM,UAAU,MAAM,OAAO,KAAK,CAAC,MAAM,CAAC;QACxC,OAAO;YAAE,IAAI;QAAQ;QACrB;IACF;IAEA,eAAe;IACf,IAAI,WAAW,WAAW,WAAW,aAAa;QAChD,MAAM,OAAO,MAAM;QACnB,MAAM,QACJ,WAAW,UACP,0BAA0B,MAAM,UAAU,IAC1C,4BAA4B,MAAM,UAAU;QAElD,MAAM,UAAU,KAAK,SAAS,CAAC;YAAE;YAAS;QAAO;QAEjD,KAAK,OAAO,CAAC,OAAO,SAAS;YAAE,KAAK;QAAE,GAAG,CAAC;YACxC,IAAI,KAAK;gBACP,QAAQ,KAAK,CAAC,mBAAmB;YACnC,OAAO;gBACL,QAAQ,GAAG,CAAC,CAAC,OAAO,EAAE,OAAO,OAAO,EAAE,OAAO;YAC/C;QACF;IACF;IAEA,OAAO,aAAa,IAAI,CAAC;AAC3B,EAAE,OAAO,KAAK;IACZ,QAAQ,KAAK,CAAC,eAAe;IAC7B,OAAO,IAAI,SAAS,SAAS;QAAE,QAAQ;IAAI;AAC7C","debugId":null}}]
}