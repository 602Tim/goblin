{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 148, "column": 0}, "map": {"version":3,"sources":["file:///D:/113-2/Breakfast-final-project/lib/prisma.ts"],"sourcesContent":["// lib/prisma.ts\r\nimport { PrismaClient } from \"@prisma/client\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\n// --- Prisma: Singleton ---\r\nconst globalForPrisma = globalThis as unknown as {\r\n  prisma?: PrismaClient;\r\n};\r\n\r\nexport const prisma =\r\n  globalForPrisma.prisma ?? new PrismaClient();\r\n\r\nif (process.env.NODE_ENV !== \"production\") {\r\n  globalForPrisma.prisma = prisma;\r\n}\r\n\r\n// --- Supabase ---\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n\r\nif (!supabaseUrl || !supabaseAnonKey) {\r\n  throw new Error(\"‚ùå Supabase Áí∞Â¢ÉËÆäÊï∏Êú™Ë®≠ÂÆö\");\r\n}\r\n\r\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey);\r\n"],"names":[],"mappings":"AAAA,gBAAgB;;;;;AAChB;AACA;;;AAEA,4BAA4B;AAC5B,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IAAI,IAAI,6HAAA,CAAA,eAAY;AAE5C,wCAA2C;IACzC,gBAAgB,MAAM,GAAG;AAC3B;AAEA,mBAAmB;AACnB,MAAM;AACN,MAAM;AAEN,uCAAsC;;AAEtC;AAEO,MAAM,WAAW,CAAA,GAAA,yLAAA,CAAA,eAAY,AAAD,EAAE,aAAa","debugId":null}},
    {"offset": {"line": 224, "column": 0}, "map": {"version":3,"sources":["file:///D:/113-2/Breakfast-final-project/lib/mqttClient.js"],"sourcesContent":["import mqtt from \"mqtt\";\r\n\r\nlet client = null;\r\n\r\nexport function getMqttClient() {\r\n  if (!client) {\r\n    client = mqtt.connect(\"wss://broker.emqx.io:8084/mqtt\");\r\n\r\n    client.on(\"connect\", () => {\r\n      console.log(\"‚úÖ MQTT Connected\");\r\n    });\r\n\r\n    client.on(\"error\", (err) => {\r\n      console.error(\"‚ùå MQTT Connection Error:\", err);\r\n    });\r\n  }\r\n\r\n  return client;\r\n}\r\n"],"names":[],"mappings":";;;AAAA;;AAEA,IAAI,SAAS;AAEN,SAAS;IACd,IAAI,CAAC,QAAQ;QACX,SAAS,wIAAA,CAAA,UAAI,CAAC,OAAO,CAAC;QAEtB,OAAO,EAAE,CAAC,WAAW;YACnB,QAAQ,GAAG,CAAC;QACd;QAEA,OAAO,EAAE,CAAC,SAAS,CAAC;YAClB,QAAQ,KAAK,CAAC,4BAA4B;QAC5C;IACF;IAEA,OAAO;AACT","debugId":null}},
    {"offset": {"line": 248, "column": 0}, "map": {"version":3,"sources":["file:///D:/113-2/Breakfast-final-project/utils/mqttTopic.ts"],"sourcesContent":["const TOPIC_ROOT = process.env.NEXT_PUBLIC_MQTT_TOPIC_ROOT;\r\n\r\nconst getTopicRoot = () => {\r\n    if (!TOPIC_ROOT) {\r\n        throw new Error(\"Êú™Â°´ÂØ´ .env ÁöÑ NEXT_PUBLIC_MQTT_TOPIC_ROOT\");\r\n    }\r\n    return `nuu/shisa/${TOPIC_ROOT}`;\r\n};\r\n\r\nexport const getOrderCheckoutTopic = () => {\r\n    const topicRoot = getTopicRoot();\r\n    return `${topicRoot}/notify/order/checkout`;\r\n};\r\nexport const getAcceptCustomerOrderTopic = (customerId: number | string) => {\r\n    const topicRoot = getTopicRoot();\r\n    return `${topicRoot}/notify/order/accept/${customerId}`;\r\n};\r\nexport const getKitchenOrderTopic = () => {\r\n    const topicRoot = getTopicRoot();\r\n    return `${topicRoot}/notify/order/kitchen`;\r\n};\r\nexport const getKitchenReadyOrderTopic = (customerId: number | string) => {\r\n    const topicRoot = getTopicRoot();\r\n    return `${topicRoot}/notify/order/ready/${customerId}`;\r\n};\r\nexport const getStaffCompletedOrderTopic = (customerId: number | string) => {\r\n    const topicRoot = getTopicRoot();\r\n    return `${topicRoot}/notify/order/completed/${customerId}`;\r\n};\r\nexport const getCustomerCancelOrderTopic = (customerId: number | string) => {\r\n    const topicRoot = getTopicRoot();\r\n    return `${topicRoot}/notify/order/cancel/${customerId}`;\r\n};\r\n\r\nexport const getOrderStatusWildcardTopic = (customerId: number | string) => {\r\n    const topicRoot = getTopicRoot();\r\n    return `${topicRoot}/notify/order/+/${customerId}`;\r\n}\r\nexport function getOrderToKitchenTopic() {\r\n  return `nuu/shisa/orders/to-kitchen`;\r\n}\r\n\r\nexport function getNotificationTopicByUserId(userId: string) {\r\n  return `nuu/shisa/notifications/${userId}`;\r\n}\r\nexport function getCustomerOrderUpdateTopic(customerId: string) {\r\n  return `nuu/shisa/customer/${customerId}/orders/updated`;\r\n}"],"names":[],"mappings":";;;;;;;;;;;;AAAA,MAAM;AAEN,MAAM,eAAe;IACjB,uCAAiB;;IAEjB;IACA,OAAO,CAAC,UAAU,EAAE,YAAY;AACpC;AAEO,MAAM,wBAAwB;IACjC,MAAM,YAAY;IAClB,OAAO,GAAG,UAAU,sBAAsB,CAAC;AAC/C;AACO,MAAM,8BAA8B,CAAC;IACxC,MAAM,YAAY;IAClB,OAAO,GAAG,UAAU,qBAAqB,EAAE,YAAY;AAC3D;AACO,MAAM,uBAAuB;IAChC,MAAM,YAAY;IAClB,OAAO,GAAG,UAAU,qBAAqB,CAAC;AAC9C;AACO,MAAM,4BAA4B,CAAC;IACtC,MAAM,YAAY;IAClB,OAAO,GAAG,UAAU,oBAAoB,EAAE,YAAY;AAC1D;AACO,MAAM,8BAA8B,CAAC;IACxC,MAAM,YAAY;IAClB,OAAO,GAAG,UAAU,wBAAwB,EAAE,YAAY;AAC9D;AACO,MAAM,8BAA8B,CAAC;IACxC,MAAM,YAAY;IAClB,OAAO,GAAG,UAAU,qBAAqB,EAAE,YAAY;AAC3D;AAEO,MAAM,8BAA8B,CAAC;IACxC,MAAM,YAAY;IAClB,OAAO,GAAG,UAAU,gBAAgB,EAAE,YAAY;AACtD;AACO,SAAS;IACd,OAAO,CAAC,2BAA2B,CAAC;AACtC;AAEO,SAAS,6BAA6B,MAAc;IACzD,OAAO,CAAC,wBAAwB,EAAE,QAAQ;AAC5C;AACO,SAAS,4BAA4B,UAAkB;IAC5D,OAAO,CAAC,mBAAmB,EAAE,WAAW,eAAe,CAAC;AAC1D","debugId":null}},
    {"offset": {"line": 310, "column": 0}, "map": {"version":3,"sources":["file:///D:/113-2/Breakfast-final-project/app/api/order/%5BorderId%5D/status/route.js"],"sourcesContent":["import { prisma } from \"@/lib/prisma\";\r\nimport { getToken } from \"next-auth/jwt\";\r\nimport { NextResponse } from \"next/server\";\r\nimport { getMqttClient } from \"@/lib/mqttClient\";\r\nimport {\r\n  getKitchenReadyOrderTopic,\r\n  getStaffCompletedOrderTopic,\r\n} from \"@/utils/mqttTopic\";\r\n\r\nconst secret = process.env.NEXTAUTH_SECRET;\r\n\r\nexport async function PATCH(req, { params }) {\r\n  const token = await getToken({ req, secret });\r\n\r\n  if (!token || ![\"STAFF\", \"CHEF\", \"OWNER\"].includes(token.role)) {\r\n    return new Response(\"Ê≤íÊúâÊ¨äÈôê\", { status: 403 });\r\n  }\r\n\r\n  const { orderId } = params;\r\n  const { status, paymentStatus } = await req.json();\r\n\r\n  if (!orderId) {\r\n    return new Response(\"Áº∫Â∞ëË®ÇÂñÆ ID\", { status: 400 });\r\n  }\r\n\r\n  try {\r\n    const order = await prisma.order.findUnique({\r\n      where: { id: orderId },\r\n    });\r\n\r\n    if (!order) {\r\n      return new Response(\"Êâæ‰∏çÂà∞Ë®ÇÂñÆ\", { status: 404 });\r\n    }\r\n\r\n    const data = {};\r\n\r\n    // ‚úÖ Â¶ÇÊûúÊ≤íÂ∏∂ statusÔºå‰ΩÜÂªöÂ∏´Âè™ÊòØÊÉ≥Ê®ôË®òÂÆåÊàêÊôÇÈñì\r\n    if (!status && order.status === \"PREPARING\" && order.completedAt === null) {\r\n      data.completedAt = new Date();\r\n    }\r\n\r\n    // ‚úÖ Ëã•ÊúâÁµ¶ statusÔºåËôïÁêÜÁãÄÊÖãÈÇèËºØ\r\n    if (status) {\r\n      if (status === \"READY\") {\r\n        if (order.status !== \"PREPARING\") {\r\n          return new Response(\"ÁãÄÊÖãÂøÖÈ†àÁÇ∫ PREPARING ÊâçËÉΩËΩâÁÇ∫ READY\", { status: 400 });\r\n        }\r\n\r\n        const isPaid = paymentStatus === true || order.paymentStatus === true;\r\n        if (!isPaid) {\r\n          return new Response(\"Â∞öÊú™Á¢∫Ë™ç‰ªòÊ¨æÔºå‰∏çËÉΩËΩâÁÇ∫ READY\", { status: 400 });\r\n        }\r\n\r\n        const isDone =\r\n          order.completedAt !== null || data.completedAt !== undefined;\r\n        if (!isDone) {\r\n          return new Response(\"Â∞öÊú™ÂÆåÊàêË£Ω‰ΩúÔºå‰∏çËÉΩËΩâÁÇ∫ READY\", { status: 400 });\r\n        }\r\n      }\r\n\r\n      data.status = status;\r\n    }\r\n\r\n    // ‚úÖ ËôïÁêÜ‰ªòÊ¨æÁãÄÊÖã\r\n    if (paymentStatus !== undefined) {\r\n      data.paymentStatus = paymentStatus;\r\n    }\r\n\r\n    // ‚úÖ ÊòéÁ¢∫ËΩâÁÇ∫ COMPLETED ÁãÄÊÖãÊôÇÔºå‰πüÂä†‰∏äÂÆåÊàêÊôÇÈñì\r\n    if (status === \"COMPLETED\") {\r\n      data.completedAt = new Date();\r\n    }\r\n\r\n    const updated = await prisma.order.update({\r\n      where: { id: orderId },\r\n      data,\r\n    });\r\n\r\n    // ‚úÖ ÁôºÈÄÅ MQTT ÈÄöÁü•\r\n    if (status === \"READY\" || status === \"COMPLETED\") {\r\n      const mqtt = await getMqttClient();\r\n      const topic =\r\n        status === \"READY\"\r\n          ? getKitchenReadyOrderTopic(order.customerId)\r\n          : getStaffCompletedOrderTopic(order.customerId);\r\n\r\n      const payload = JSON.stringify({ orderId, status });\r\n\r\n      mqtt.publish(topic, payload, { qos: 1 }, (err) => {\r\n        if (err) {\r\n          console.error(\"‚ùå ÁôºÈÄÅ MQTT ÈÄöÁü•Â§±Êïó:\", err);\r\n        } else {\r\n          console.log(`üì¢ Â∑≤ÁôºÈÄÅ ${status} ÁãÄÊÖãÈÄöÁü•Ëá≥ ${topic}`);\r\n        }\r\n      });\r\n    }\r\n\r\n    return NextResponse.json(updated);\r\n  } catch (err) {\r\n    console.error(\"‚ùå Êõ¥Êñ∞Ë®ÇÂñÆÁãÄÊÖãÂ§±Êïó:\", err);\r\n    return new Response(\"‰º∫ÊúçÂô®ÈåØË™§\", { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAKA,MAAM,SAAS,QAAQ,GAAG,CAAC,eAAe;AAEnC,eAAe,MAAM,GAAG,EAAE,EAAE,MAAM,EAAE;IACzC,MAAM,QAAQ,MAAM,CAAA,GAAA,8IAAA,CAAA,WAAQ,AAAD,EAAE;QAAE;QAAK;IAAO;IAE3C,IAAI,CAAC,SAAS,CAAC;QAAC;QAAS;QAAQ;KAAQ,CAAC,QAAQ,CAAC,MAAM,IAAI,GAAG;QAC9D,OAAO,IAAI,SAAS,QAAQ;YAAE,QAAQ;QAAI;IAC5C;IAEA,MAAM,EAAE,OAAO,EAAE,GAAG;IACpB,MAAM,EAAE,MAAM,EAAE,aAAa,EAAE,GAAG,MAAM,IAAI,IAAI;IAEhD,IAAI,CAAC,SAAS;QACZ,OAAO,IAAI,SAAS,WAAW;YAAE,QAAQ;QAAI;IAC/C;IAEA,IAAI;QACF,MAAM,QAAQ,MAAM,+GAAA,CAAA,SAAM,CAAC,KAAK,CAAC,UAAU,CAAC;YAC1C,OAAO;gBAAE,IAAI;YAAQ;QACvB;QAEA,IAAI,CAAC,OAAO;YACV,OAAO,IAAI,SAAS,SAAS;gBAAE,QAAQ;YAAI;QAC7C;QAEA,MAAM,OAAO,CAAC;QAEd,6BAA6B;QAC7B,IAAI,CAAC,UAAU,MAAM,MAAM,KAAK,eAAe,MAAM,WAAW,KAAK,MAAM;YACzE,KAAK,WAAW,GAAG,IAAI;QACzB;QAEA,sBAAsB;QACtB,IAAI,QAAQ;YACV,IAAI,WAAW,SAAS;gBACtB,IAAI,MAAM,MAAM,KAAK,aAAa;oBAChC,OAAO,IAAI,SAAS,8BAA8B;wBAAE,QAAQ;oBAAI;gBAClE;gBAEA,MAAM,SAAS,kBAAkB,QAAQ,MAAM,aAAa,KAAK;gBACjE,IAAI,CAAC,QAAQ;oBACX,OAAO,IAAI,SAAS,qBAAqB;wBAAE,QAAQ;oBAAI;gBACzD;gBAEA,MAAM,SACJ,MAAM,WAAW,KAAK,QAAQ,KAAK,WAAW,KAAK;gBACrD,IAAI,CAAC,QAAQ;oBACX,OAAO,IAAI,SAAS,qBAAqB;wBAAE,QAAQ;oBAAI;gBACzD;YACF;YAEA,KAAK,MAAM,GAAG;QAChB;QAEA,WAAW;QACX,IAAI,kBAAkB,WAAW;YAC/B,KAAK,aAAa,GAAG;QACvB;QAEA,+BAA+B;QAC/B,IAAI,WAAW,aAAa;YAC1B,KAAK,WAAW,GAAG,IAAI;QACzB;QAEA,MAAM,UAAU,MAAM,+GAAA,CAAA,SAAM,CAAC,KAAK,CAAC,MAAM,CAAC;YACxC,OAAO;gBAAE,IAAI;YAAQ;YACrB;QACF;QAEA,eAAe;QACf,IAAI,WAAW,WAAW,WAAW,aAAa;YAChD,MAAM,OAAO,MAAM,CAAA,GAAA,mHAAA,CAAA,gBAAa,AAAD;YAC/B,MAAM,QACJ,WAAW,UACP,CAAA,GAAA,oHAAA,CAAA,4BAAyB,AAAD,EAAE,MAAM,UAAU,IAC1C,CAAA,GAAA,oHAAA,CAAA,8BAA2B,AAAD,EAAE,MAAM,UAAU;YAElD,MAAM,UAAU,KAAK,SAAS,CAAC;gBAAE;gBAAS;YAAO;YAEjD,KAAK,OAAO,CAAC,OAAO,SAAS;gBAAE,KAAK;YAAE,GAAG,CAAC;gBACxC,IAAI,KAAK;oBACP,QAAQ,KAAK,CAAC,mBAAmB;gBACnC,OAAO;oBACL,QAAQ,GAAG,CAAC,CAAC,OAAO,EAAE,OAAO,OAAO,EAAE,OAAO;gBAC/C;YACF;QACF;QAEA,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,eAAe;QAC7B,OAAO,IAAI,SAAS,SAAS;YAAE,QAAQ;QAAI;IAC7C;AACF","debugId":null}}]
}